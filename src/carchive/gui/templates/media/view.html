{% extends 'layout.html' %}

{% block title %}{% if media.get('original_file_name') %}{{ media.get('original_file_name') }}{% else %}Media Viewer{% endif %}{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .media-container {
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .media-viewer {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    max-height: 600px;
    overflow: hidden;
    position: relative;
  }
  
  .media-viewer img {
    max-width: 100%;
    max-height: 500px;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .media-viewer img:hover {
    transform: scale(1.02);
  }
  
  .media-placeholder {
    font-size: 5rem;
    color: #adb5bd;
    text-align: center;
    padding: 40px 0;
  }
  
  .media-info-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .media-property {
    margin-bottom: 10px;
    display: flex;
    border-bottom: 1px solid #f5f5f5;
    padding-bottom: 8px;
  }
  
  .property-label {
    font-weight: 500;
    width: 150px;
    color: #495057;
  }
  
  .property-value {
    color: #212529;
    flex: 1;
    word-break: break-word;
  }
  
  .message-preview {
    padding: 15px;
    border-left: 4px solid #007bff;
    background-color: #f8f9fa;
    margin-bottom: 15px;
    border-radius: 0 5px 5px 0;
    transition: transform 0.2s ease;
  }
  
  .message-preview:hover {
    transform: translateX(5px);
  }
  
  .message-content {
    max-height: 100px;
    overflow: hidden;
    position: relative;
  }
  
  .message-content::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 40px;
    background: linear-gradient(transparent, #f8f9fa);
  }
  
  .breadcrumb {
    background-color: #f8f9fa;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
  }
  
  .error-card {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    background-color: #fff3cd;
    border: 1px solid #ffecb5;
  }
  
  .debug-info {
    font-family: monospace;
    font-size: 0.85rem;
    background-color: #343a40;
    color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    overflow-x: auto;
    max-height: 300px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Navigation breadcrumbs -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('media.list_media') }}">Media Gallery</a></li>
      <li class="breadcrumb-item active">
        {% if media.get('original_file_name') %}
          {{ media.get('original_file_name')|truncate(40) }}
        {% else %}
          Media Viewer
        {% endif %}
      </li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h2>
            <i class="fas fa-file"></i> 
            {% if media.get('original_file_name') %}
              {{ media.get('original_file_name')|truncate(40) }}
            {% else %}
              Media Viewer
            {% endif %}
          </h2>
          <div>
            <a href="{{ url_for('media.list_media') }}" class="btn btn-light btn-sm me-2">
              <i class="fas fa-images"></i> Gallery
            </a>
            <a href="{{ url_for('main.index') }}" class="btn btn-light btn-sm">
              <i class="fas fa-home"></i> Home
            </a>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Error handling section -->
          {% if api_error %}
            <div class="error-card">
              <h4 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error</h4>
              <p>{{ api_error }}</p>
              
              {% if debug_info %}
                <details>
                  <summary class="text-primary cursor-pointer">Technical Details</summary>
                  <div class="debug-info mt-2">
                    <pre>{{ debug_info }}</pre>
                  </div>
                </details>
              {% endif %}
              
              <div class="mt-3">
                <a href="{{ url_for('media.list_media') }}" class="btn btn-outline-primary">
                  <i class="fas fa-arrow-left"></i> Back to Gallery
                </a>
              </div>
            </div>
          {% elif not media %}
            <div class="error-card">
              <h4 class="text-warning"><i class="fas fa-question-circle"></i> Media Not Found</h4>
              <p>The requested media item could not be found or loaded.</p>
              <div class="mt-3">
                <a href="{{ url_for('media.list_media') }}" class="btn btn-outline-primary">
                  <i class="fas fa-arrow-left"></i> Back to Gallery
                </a>
              </div>
            </div>
          {% elif media.error is defined %}
            <div class="error-card">
              <h4 class="text-warning"><i class="fas fa-exclamation-circle"></i> Media Error</h4>
              <p>There was an error with this media item: {{ media.error }}</p>
              <div class="mt-3">
                <a href="{{ url_for('media.list_media') }}" class="btn btn-outline-primary">
                  <i class="fas fa-arrow-left"></i> Back to Gallery
                </a>
              </div>
            </div>
          {% else %}
            <!-- Media Viewer -->
            <div class="media-container">
              <div class="media-viewer">
                {% if media.id %}
                  {% if media.get('media_type') == 'image' %}
                    <img 
                      src="{{ api_url|default('http://localhost:8000') }}/api/media/{{ media.id }}/file" 
                      alt="{{ media.get('original_file_name') or 'Image' }}" 
                      crossorigin="anonymous"
                      class="img-fluid mx-auto d-block"
                      style="max-height: 500px; object-fit: contain;"
                      onerror="this.onerror=null; this.src='/static/img/broken-image.png'; this.alt='Error loading image';"
                      loading="lazy"
                    >
                  {% elif media.get('media_type') == 'pdf' %}
                    <div class="pdf-container text-center">
                      <object 
                        data="{{ api_url|default('http://localhost:8000') }}/api/media/{{ media.id }}/file" 
                        type="application/pdf" 
                        width="100%" 
                        height="500px"
                      >
                        <p>PDF preview not available. <a href="{{ api_url|default('http://localhost:8000') }}/api/media/{{ media.id }}/file" target="_blank" class="btn btn-primary btn-sm">Open PDF in New Tab</a></p>
                      </object>
                    </div>
                  {% elif media.get('media_type') == 'audio' %}
                    <div class="text-center p-4 bg-light rounded">
                      <div class="mb-3">
                        <i class="fas fa-volume-up fa-3x text-primary mb-3"></i>
                        <h5>{{ media.get('original_file_name') or 'Audio File' }}</h5>
                      </div>
                      <audio controls style="width: 90%;" crossorigin="anonymous" class="mt-3">
                        <source src="{{ api_url|default('http://localhost:8000') }}/api/media/{{ media.id }}/file" type="audio/mpeg">
                        Your browser does not support the audio element.
                      </audio>
                    </div>
                  {% elif media.get('media_type') == 'video' %}
                    <div class="text-center p-2">
                      <video controls style="max-width: 100%; max-height: 500px;" crossorigin="anonymous" class="shadow rounded">
                        <source src="{{ api_url|default('http://localhost:8000') }}/api/media/{{ media.id }}/file" type="video/mp4">
                        Your browser does not support the video element.
                      </video>
                    </div>
                  {% else %}
                    <div class="media-placeholder text-center">
                      <i class="fas fa-file fa-4x mb-3 text-secondary"></i>
                      <h4 class="text-secondary">Preview not available</h4>
                      <p class="text-muted">File type: {{ media.get('media_type')|default('unknown')|upper }}</p>
                      <a href="{{ api_url|default('http://localhost:8000') }}/api/media/{{ media.id }}/file" class="btn btn-primary mt-3" target="_blank">
                        <i class="fas fa-download"></i> Download File
                      </a>
                    </div>
                  {% endif %}
                {% else %}
                  <div class="alert alert-danger">
                    <p>Invalid media data: Missing media ID</p>
                  </div>
                {% endif %}
              </div>
            </div>
            
            <!-- Media Info Card -->
            <div class="row">
              <div class="col-md-6">
                <div class="media-info-card">
                  <h4 class="mb-3"><i class="fas fa-info-circle"></i> Media Information</h4>
                  <hr>
                  
                  <div class="media-property">
                    <div class="property-label">File Name:</div>
                    <div class="property-value">{{ media.get('original_file_name', 'Unknown') }}</div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">File Type:</div>
                    <div class="property-value">{{ media.get('media_type', 'Unknown') }}</div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">MIME Type:</div>
                    <div class="property-value">{{ media.get('mime_type', 'Unknown') }}</div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">File Size:</div>
                    <div class="property-value">
                      {% if media.get('file_size') %}
                        {{ (media.get('file_size') / 1024)|round|int }} KB
                      {% else %}
                        Unknown
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">Created:</div>
                    <div class="property-value">
                      {% if media.get('created_at') %}
                        {{ media.get('created_at')|datetime }}
                      {% else %}
                        Unknown
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">Source:</div>
                    <div class="property-value">
                      {% if media.get('is_generated', False) %}
                        <span class="badge bg-success">AI Generated</span>
                      {% else %}
                        <span class="badge bg-info">User Uploaded</span>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">Original ID:</div>
                    <div class="property-value">{{ media.get('original_file_id', 'N/A') }}</div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">Media ID:</div>
                    <div class="property-value">{{ media.get('id', 'Unknown') }}</div>
                  </div>
                  
                  <div class="media-property">
                    <div class="property-label">File Path:</div>
                    <div class="property-value text-truncate" title="{{ media.get('file_path', 'Unknown') }}">
                      {{ media.get('file_path', 'Unknown') }}
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Associated Messages -->
                <div class="media-info-card">
                  <h4 class="mb-3"><i class="fas fa-comments"></i> Associated Messages</h4>
                  <hr>
                  
                  {% if associated_messages %}
                    {% for message in associated_messages %}
                      <div class="message-preview">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="badge {% if message.get('role') == 'uploader' %}bg-info{% else %}bg-success{% endif %}">
                            {{ message.get('role', 'Unknown')|capitalize }} Message
                          </span>
                          <small class="text-muted">{{ message.get('created_at')|datetime }}</small>
                        </div>
                        
                        <div class="message-content">
                          {{ message.get('content', 'No content available') }}
                        </div>
                        
                        <div class="mt-3">
                          {% if message.get('url') %}
                            <a href="{{ message.get('url') }}" class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-eye"></i> View Message
                            </a>
                          {% endif %}
                          
                          {% if message.get('conversation_url') %}
                            <a href="{{ message.get('conversation_url') }}" class="btn btn-sm btn-outline-secondary">
                              <i class="fas fa-comments"></i> View Conversation
                            </a>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="alert alert-info">
                      <i class="fas fa-info-circle"></i> No associated messages found for this media file.
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Enhanced image loading error handling
    const mediaImage = document.querySelector('.media-viewer img');
    if (mediaImage) {
      // Apply fade-in effect on successful load
      mediaImage.style.opacity = '0';
      mediaImage.style.transition = 'opacity 0.3s ease-in';
      
      mediaImage.onload = function() {
        mediaImage.style.opacity = '1';
        console.log('Image loaded successfully:', this.src);
      };
      
      // Handle loading errors with detailed fallback
      mediaImage.onerror = function() {
        const parent = this.parentNode;
        const mediaId = '{{ media.get("id", "") }}';
        const apiUrl = '{{ api_url|default("http://localhost:8000") }}';
        const fileName = '{{ media.get("original_file_name", "Unknown file") }}';
        
        console.error(`Failed to load image for media ID: ${mediaId} from ${this.src}`);
        
        // Replace with error placeholder
        parent.innerHTML = `
          <div class="media-placeholder shadow-sm p-4 bg-light rounded">
            <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
            <h4 class="text-danger">Image Loading Error</h4>
            <p class="text-secondary mb-3">Unable to load: ${fileName}</p>
            <div class="alert alert-warning">
              <small>Error loading from: ${this.src}</small>
            </div>
            <div class="mt-4">
              <a href="${apiUrl}/api/media/${mediaId}/file" class="btn btn-primary me-2" target="_blank">
                <i class="fas fa-download"></i> Download File
              </a>
              <a href="${apiUrl}/api/media/${mediaId}/thumbnail" class="btn btn-outline-secondary" target="_blank">
                <i class="fas fa-image"></i> Try Thumbnail
              </a>
            </div>
          </div>
        `;
      };
    }
    
    // Add tooltips to truncated values
    document.querySelectorAll('.text-truncate').forEach(el => {
      el.title = el.innerText;
      el.style.cursor = 'help';
    });
    
    // Track view in analytics (if implemented)
    try {
      console.log('Viewing media: {{ media.get("id", "") }}');
      // Future analytics implementation here
    } catch (e) {
      console.error('Analytics error:', e);
    }
  });
</script>
{% endblock %}