{% extends 'layout.html' %}

{% block title %}Search{% endblock %}

{% block content %}
<div class="container">
  <h1 class="my-4">Search</h1>
  
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Search Archives</h5>
    </div>
    <div class="card-body">
      <form action="{{ url_for('search.search_results') }}" method="get">
        <div class="mb-3">
          <label for="search-query" class="form-label">Search Query</label>
          <input type="text" class="form-control form-control-lg" id="search-query" name="q" placeholder="Enter your search query..." required>
          <div class="form-text">
            Search for conversations, messages, or media content.
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="search-type" name="type">
                <option value="all" selected>All Content Types</option>
                <option value="conversations">Conversations</option>
                <option value="messages">Messages</option>
                <option value="media">Media</option>
                <option value="chunk">Chunks</option>
                <option value="gencom">Generated Content</option>
              </select>
              <label for="search-type">Content Type</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="search-date-range" name="date_range">
                <option value="all" selected>All Time</option>
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
                <option value="year">Last Year</option>
                <option value="custom">Custom Range</option>
              </select>
              <label for="search-date-range">Date Range</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="search-sort" name="sort">
                <option value="relevance" selected>Most Relevant</option>
                <option value="date_desc">Newest First</option>
                <option value="date_asc">Oldest First</option>
                <option value="alpha_asc">A-Z</option>
                <option value="alpha_desc">Z-A</option>
              </select>
              <label for="search-sort">Sort By</label>
            </div>
          </div>
        </div>
        
        <!-- Custom date range (hidden by default, shown when Custom Range is selected) -->
        <div class="row mb-3" id="custom-date-range" style="display: none;">
          <div class="col-md-6">
            <div class="form-group">
              <label for="start-date">Start Date</label>
              <input type="date" class="form-control" id="start-date" name="start_date">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="end-date">End Date</label>
              <input type="date" class="form-control" id="end-date" name="end_date">
            </div>
          </div>
        </div>
        
        <div class="card mb-3">
          <div class="card-header">Advanced Options</div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="semantic-search" name="semantic" value="true" checked>
                  <label class="form-check-label" for="semantic-search">Enable Semantic Search</label>
                </div>
                <div class="form-text">Use vector embeddings for more accurate results.</div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="exact-match" name="exact" value="true">
                  <label class="form-check-label" for="exact-match">Exact Match</label>
                </div>
                <div class="form-text">Only return exact matches for the query.</div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Search Mode</label>
                <select class="form-select" id="search-mode" name="mode">
                  <option value="substring" selected>Substring Match</option>
                  <option value="exact">Exact Match</option>
                  <option value="any_word">Any Word</option>
                  <option value="all_words">All Words</option>
                  <option value="regex">Regular Expression</option>
                </select>
                <div class="form-text">How to match the search query.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Max Results</label>
                <select class="form-select" id="per-page" name="per_page">
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <div class="form-text">Maximum number of results to return.</div>
              </div>
            </div>
            
            <!-- Filters -->
            <div class="accordion" id="accordionFilters">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingRoles">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRoles" aria-expanded="false" aria-controls="collapseRoles">
                    Filter by Role
                  </button>
                </h2>
                <div id="collapseRoles" class="accordion-collapse collapse" aria-labelledby="headingRoles" data-bs-parent="#accordionFilters">
                  <div class="accordion-body">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="role" value="user" id="role-user">
                      <label class="form-check-label" for="role-user">User</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="role" value="assistant" id="role-assistant">
                      <label class="form-check-label" for="role-assistant">Assistant</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="role" value="system" id="role-system">
                      <label class="form-check-label" for="role-system">System</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="role" value="tool" id="role-tool">
                      <label class="form-check-label" for="role-tool">Tool</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingProviders">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProviders" aria-expanded="false" aria-controls="collapseProviders">
                    Filter by Provider
                  </button>
                </h2>
                <div id="collapseProviders" class="accordion-collapse collapse" aria-labelledby="headingProviders" data-bs-parent="#accordionFilters">
                  <div class="accordion-body">
                    {% if providers %}
                      {% for provider in providers %}
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="provider" value="{{ provider.id }}" id="provider-{{ provider.id }}">
                          <label class="form-check-label" for="provider-{{ provider.id }}">{{ provider.name }}</label>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="alert alert-info">No providers available</div>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingGencomTypes">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGencomTypes" aria-expanded="false" aria-controls="collapseGencomTypes">
                    Generated Content Types
                  </button>
                </h2>
                <div id="collapseGencomTypes" class="accordion-collapse collapse" aria-labelledby="headingGencomTypes" data-bs-parent="#accordionFilters">
                  <div class="accordion-body">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="gencom_type" value="summary" id="gencom-summary">
                      <label class="form-check-label" for="gencom-summary">Summaries</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="gencom_type" value="category" id="gencom-category">
                      <label class="form-check-label" for="gencom-category">Categories</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="gencom_type" value="analysis" id="gencom-analysis">
                      <label class="form-check-label" for="gencom-analysis">Analysis</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="text-center">
          <button type="submit" class="btn btn-primary btn-lg">Search</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Recent Saved Searches</h5>
    </div>
    <div class="card-body">
      <div class="list-group">
        {% if saved_searches %}
          {% for search in saved_searches %}
            <a href="{{ url_for('search.search_results') }}?q={{ search.query|urlencode }}&type={{ search.type|default('all')|urlencode }}" 
               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <span>{{ search.name }}</span>
              <div>
                <span class="badge bg-primary rounded-pill">{{ search.query|truncate(20) }}</span>
                <span class="badge bg-secondary rounded-pill">{{ search.created_at|default('Unknown')|truncate(10) }}</span>
              </div>
            </a>
          {% endfor %}
        {% else %}
          <div class="alert alert-info">No saved searches yet. Search for something and save it for quick access later.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show/hide custom date range based on selection
    const dateRangeSelect = document.getElementById('search-date-range');
    const customDateRange = document.getElementById('custom-date-range');
    
    dateRangeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customDateRange.style.display = 'flex';
      } else {
        customDateRange.style.display = 'none';
      }
    });
    
    // Update search mode when exact match is toggled
    const exactMatchCheckbox = document.getElementById('exact-match');
    const searchModeSelect = document.getElementById('search-mode');
    
    exactMatchCheckbox.addEventListener('change', function() {
      if (this.checked) {
        searchModeSelect.value = 'exact';
      } else {
        searchModeSelect.value = 'substring';
      }
    });
    
    // Update exact match when search mode is changed
    searchModeSelect.addEventListener('change', function() {
      if (this.value === 'exact') {
        exactMatchCheckbox.checked = true;
      } else {
        exactMatchCheckbox.checked = false;
      }
    });
  });
</script>
{% endblock %}